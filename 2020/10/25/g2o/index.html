<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="g2o"><meta name="keywords" content="robotic"><meta name="author" content="hero576"><meta name="copyright" content="hero576"><title>g2o | void land space</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.8.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.8.2"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?5ff8fca367285c16c6dd5c16ca2ccc1b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.0.2'
} </script><meta name="generator" content="Hexo 5.0.2"><link rel="alternate" href="/atom.xml" title="void land space" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text"> 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text"> 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.</span> <span class="toc-text"> 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95"><span class="toc-number">1.3.</span> <span class="toc-text"> 目录</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.</span> <span class="toc-text"> 示例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8C%E8%A7%86%E5%9B%BEbundle-adjustment"><span class="toc-number">2.1.</span> <span class="toc-text"> 双视图bundle adjustment</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/images/haimianbaobao.jpg"></div><div class="author-info__name text-center">hero576</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">66</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">5</span></a></div></div></div><div id="content-outer"><div class="plain" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">void land space</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">主页</a><a class="site-page" href="/archives">文章</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a><a class="site-page" href="/gallery">相册</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div></div><div class="layout" id="content-inner"><article id="post"><div class="plain" id="post-title">g2o</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-10-25</time><span class="post-meta__separator">|</span><i class="fa fa-inbox" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/programme/"> programme</a></div><div class="article-container" id="post-content"><blockquote>
<p>g2o图优化</p>
</blockquote>
<a id="more"></a>
<h1 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h1>
<ul>
<li>ceres可以求解最优化问题，而g2o在此基础上，对so(3)，se(3)也有支持，是slam中常用的库。</li>
</ul>
<h2 id="介绍"><a class="markdownIt-Anchor" href="#介绍"></a> 介绍</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gaoxiang12/p/5304272.html">教程链接</a></li>
<li>2o全称是什么？来跟我大声说一遍：General Graph Optimization！你可以叫它g土o，g二o，g方o，总之我也不知道该怎么叫它……</li>
<li>所谓的通用图优化。</li>
<li>为何叫通用呢？g2o的核里带有各种各样的求解器，而它的顶点、边的类型则多种多样。通过自定义顶点和边，事实上，只要一个优化问题能够表达成图，那么就可以用g2o去求解它。常见的，比如bundle adjustment，ICP，数据拟合，都可以用g2o来做。甚至我还在想神经网络能不能写成图优化的形式呢……</li>
<li>从代码层面来说，g2o是一个c++编写的项目，用cmake构建。它的github地址在：<a target="_blank" rel="noopener" href="https://github.com/RainerKuemmerle/g2o">https://github.com/RainerKuemmerle/g2o</a></li>
<li>它是一个重度模板类的c++项目，其中矩阵数据结构多来自Eigen</li>
</ul>
<h2 id="安装"><a class="markdownIt-Anchor" href="#安装"></a> 安装</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/RainerKuemmerle/g2o</span><br></pre></td></tr></table></figure>
<h2 id="目录"><a class="markdownIt-Anchor" href="#目录"></a> 目录</h2>
<p>如你所见，g2o项目中含有若干文件夹。刨开那些gitignore之类的零碎文件，主要有以下几个：</p>
<table>
<thead>
<tr>
<th>目录</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>EXTERNAL</td>
<td>三方库，有ceres, csparse, freeglut，可以选择性地编译；</td>
</tr>
<tr>
<td>cmake_modules</td>
<td>给cmake用来寻找库的文件。我们用g2o时也会用它里头的东西，例如FindG2O.cmake</td>
</tr>
<tr>
<td>doc</td>
<td>文档。包括g2o自带的说明书（难度挺大的一个说明文档）。</td>
</tr>
<tr>
<td>g2o</td>
<td>最重要的源代码都在这里！</td>
</tr>
<tr>
<td>script</td>
<td>在android等其他系统编译用的脚本，由于我们在ubuntu下就没必要多讲了。</td>
</tr>
</tbody>
</table>
<p>最重要的就是g2o的源代码文件啦，我们同样地介绍一下各文件夹的内容：</p>
<table>
<thead>
<tr>
<th>目录</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>apps</td>
<td>一些应用程序。好用的g2o_viewer就在这里。其他还有一些不常用的命令行工具等。</td>
</tr>
<tr>
<td>core</td>
<td>核心组件，很重要！基本的顶点、边、图结构的定义，算法的定义，求解器接口的定义在这里。</td>
</tr>
<tr>
<td>examples</td>
<td>一些例程，可以参照着这里的东西来写。不过注释不太多。</td>
</tr>
<tr>
<td>solvers</td>
<td>求解器的实现。主要来自choldmod, csparse。在使用g2o时要先选择其中一种。</td>
</tr>
<tr>
<td>stuff</td>
<td>对用户来讲可有可无的一些工具函数。</td>
</tr>
<tr>
<td>types</td>
<td>各种顶点和边，很重要！我们用户在构建图优化问题时，先要想好自己的顶点和边是否已经提供了定义。如果没有，要自己实现。如果有，就用g2o提供的即可。</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>就经验而言，solvers给人的感觉是大同小异，而 types 的选取，则是 g2o 用户主要关心的内容。然后 core 下面的内容，我们要争取弄的比较熟悉，才能确保使用中出现错误可以正确地应对。</p>
</li>
<li>
<p>那么，g2o最基本的类结构是怎么样的呢？我们如何来表达一个Graph，选择求解器呢？我们祭出一张图：<br />
<img src="/images/pasted-319.png" alt="" /></p>
</li>
<li>
<p>先看上半部分。SparseOptimizer 是我们最终要维护的东东。它是一个Optimizable Graph，从而也是一个Hyper Graph。一个 SparseOptimizer 含有很多个顶点 （都继承自 Base Vertex）和很多个边（继承自 BaseUnaryEdge, BaseBinaryEdge或BaseMultiEdge）。这些 Base Vertex 和 Base Edge 都是抽象的基类，而实际用的顶点和边，都是它们的派生类。我们用 SparseOptimizer.addVertex 和 SparseOptimizer.addEdge 向一个图中添加顶点和边，最后调用 SparseOptimizer.optimize 完成优化。</p>
</li>
<li>
<p>在优化之前，需要指定我们用的求解器和迭代算法。从图中下半部分可以看到，一个 SparseOptimizer 拥有一个 Optimization Algorithm，继承自Gauss-Newton, Levernberg-Marquardt, Powell’s dogleg 三者之一（我们常用的是GN或LM）。同时，这个 Optimization Algorithm 拥有一个Solver，它含有两个部分。一个是 SparseBlockMatrix ，用于计算稀疏的雅可比和海塞； 一个是用于计算迭代过程中最关键的一步</p>
</li>
</ul>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>H</mi><mi mathvariant="normal">Δ</mi><mi>x</mi><mo>=</mo><mo>−</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">HΔx=-b
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mord">Δ</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord mathdefault">b</span></span></span></span></span></p>
<ul>
<li>
<p>这就需要一个线性方程的求解器。而这个求解器，可以从 PCG, CSparse, Choldmod 三者选一。</p>
</li>
<li>
<p>综上所述，在g2o中选择优化方法一共需要三个步骤：</p>
<ul>
<li>选择一个线性方程求解器，从 PCG, CSparse, Choldmod中选，实际则来自 g2o/solvers 文件夹中定义的东东。</li>
<li>选择一个 BlockSolver 。</li>
<li>选择一个迭代策略，从GN, LM, Doglog中选。</li>
</ul>
</li>
<li>
<p>这样一来，读者是否对g2o就更清楚的认识了呢？</p>
</li>
</ul>
<h1 id="示例"><a class="markdownIt-Anchor" href="#示例"></a> 示例</h1>
<h2 id="双视图bundle-adjustment"><a class="markdownIt-Anchor" href="#双视图bundle-adjustment"></a> 双视图bundle adjustment</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/gaoxiang12/g2o_ba_example">代码的git地址</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BA Example</span></span><br><span class="line"><span class="comment"> * Author: Xiang Gao</span></span><br><span class="line"><span class="comment"> * Date: 2016.3</span></span><br><span class="line"><span class="comment"> * Email: gaoxiang12@mails.tsinghua.edu.cn</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 在这个程序中，我们读取两张图像，进行特征匹配。然后根据匹配得到的特征，计算相机运动以及特征点的位置。这是一个典型的Bundle Adjustment，我们用g2o进行优化。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// for std</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="comment">// for opencv</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/features2d/features2d.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/concept_check.hpp&gt;</span></span></span><br><span class="line"><span class="comment">// for g2o</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g2o/core/sparse_optimizer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g2o/core/block_solver.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g2o/core/robust_kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g2o/core/robust_kernel_impl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g2o/core/optimization_algorithm_levenberg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g2o/solvers/cholmod/linear_solver_cholmod.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g2o/types/slam3d/se3quat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g2o/types/sba/types_six_dof_expmap.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="comment">// 寻找两个图像中的对应点，像素坐标系</span></span><br><span class="line"><span class="comment">// 输入：img1, img2 两张图像</span></span><br><span class="line"><span class="comment">// 输出：points1, points2, 两组对应的2D点</span></span><br><span class="line"><span class="function"><span class="keyword">int</span>     <span class="title">findCorrespondingPoints</span><span class="params">( <span class="keyword">const</span> cv::Mat&amp; img1, <span class="keyword">const</span> cv::Mat&amp; img2, <span class="built_in">vector</span>&lt;cv::Point2f&gt;&amp; points1, <span class="built_in">vector</span>&lt;cv::Point2f&gt;&amp; points2 )</span></span>;</span><br><span class="line"><span class="comment">// 相机内参</span></span><br><span class="line"><span class="keyword">double</span> cx = <span class="number">325.5</span>;</span><br><span class="line"><span class="keyword">double</span> cy = <span class="number">253.5</span>;</span><br><span class="line"><span class="keyword">double</span> fx = <span class="number">518.0</span>;</span><br><span class="line"><span class="keyword">double</span> fy = <span class="number">519.0</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">int</span> argc, <span class="keyword">char</span>** argv )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 调用格式：命令 [第一个图] [第二个图]</span></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;Usage: ba_example img1, img2&quot;</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 读取图像</span></span><br><span class="line">    cv::Mat img1 = cv::imread( argv[<span class="number">1</span>] );</span><br><span class="line">    cv::Mat img2 = cv::imread( argv[<span class="number">2</span>] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到对应点</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;cv::Point2f&gt; pts1, pts2;</span><br><span class="line">    <span class="keyword">if</span> ( findCorrespondingPoints( img1, img2, pts1, pts2 ) == <span class="literal">false</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;匹配点不够！&quot;</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;找到了&quot;</span>&lt;&lt;pts1.size()&lt;&lt;<span class="string">&quot;组对应特征点。&quot;</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="comment">// 构造g2o中的图</span></span><br><span class="line">    <span class="comment">// 先构造求解器</span></span><br><span class="line">    g2o::SparseOptimizer    optimizer;</span><br><span class="line">    <span class="comment">// 使用Cholmod中的线性方程求解器</span></span><br><span class="line">    g2o::BlockSolver_6_3::LinearSolverType* linearSolver = <span class="keyword">new</span>  g2o::LinearSolverCholmod&lt;g2o::BlockSolver_6_3::PoseMatrixType&gt; ();</span><br><span class="line">    <span class="comment">// 6*3 的参数</span></span><br><span class="line">    g2o::BlockSolver_6_3* block_solver = <span class="keyword">new</span> g2o::BlockSolver_6_3( linearSolver );</span><br><span class="line">    <span class="comment">// L-M 下降</span></span><br><span class="line">    g2o::OptimizationAlgorithmLevenberg* algorithm = <span class="keyword">new</span> g2o::OptimizationAlgorithmLevenberg( block_solver );</span><br><span class="line"></span><br><span class="line">    optimizer.setAlgorithm( algorithm );</span><br><span class="line">    optimizer.setVerbose( <span class="literal">false</span> );</span><br><span class="line">    <span class="comment">// 添加节点</span></span><br><span class="line">    <span class="comment">// 两个位姿节点</span></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">2</span>; i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        g2o::VertexSE3Expmap* v = <span class="keyword">new</span> g2o::VertexSE3Expmap();</span><br><span class="line">        v-&gt;setId(i);</span><br><span class="line">        <span class="keyword">if</span> ( i == <span class="number">0</span>)</span><br><span class="line">            v-&gt;setFixed( <span class="literal">true</span> ); <span class="comment">// 第一个点固定为零</span></span><br><span class="line">        <span class="comment">// 预设值为单位Pose，因为我们不知道任何信息</span></span><br><span class="line">        v-&gt;setEstimate( g2o::SE3Quat() );</span><br><span class="line">        optimizer.addVertex( v );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 很多个特征点的节点</span></span><br><span class="line">    <span class="comment">// 以第一帧为准</span></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">size_t</span> i=<span class="number">0</span>; i&lt;pts1.size(); i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        g2o::VertexSBAPointXYZ* v = <span class="keyword">new</span> g2o::VertexSBAPointXYZ();</span><br><span class="line">        v-&gt;setId( <span class="number">2</span> + i );</span><br><span class="line">        <span class="comment">// 由于深度不知道，只能把深度设置为1了</span></span><br><span class="line">        <span class="keyword">double</span> z = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">double</span> x = ( pts1[i].x - cx ) * z / fx;</span><br><span class="line">        <span class="keyword">double</span> y = ( pts1[i].y - cy ) * z / fy;</span><br><span class="line">        v-&gt;setMarginalized(<span class="literal">true</span>);</span><br><span class="line">        v-&gt;setEstimate( Eigen::Vector3d(x,y,z) );</span><br><span class="line">        optimizer.addVertex( v );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 准备相机参数</span></span><br><span class="line">    g2o::CameraParameters* camera = <span class="keyword">new</span> g2o::CameraParameters( fx, Eigen::Vector2d(cx, cy), <span class="number">0</span> );</span><br><span class="line">    camera-&gt;setId(<span class="number">0</span>);</span><br><span class="line">    optimizer.addParameter( camera );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 准备边</span></span><br><span class="line">    <span class="comment">// 第一帧</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;g2o::EdgeProjectXYZ2UV*&gt; edges;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">size_t</span> i=<span class="number">0</span>; i&lt;pts1.size(); i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        g2o::EdgeProjectXYZ2UV*  edge = <span class="keyword">new</span> g2o::EdgeProjectXYZ2UV();</span><br><span class="line">        edge-&gt;setVertex( <span class="number">0</span>, <span class="keyword">dynamic_cast</span>&lt;g2o::VertexSBAPointXYZ*&gt;   (optimizer.vertex(i+<span class="number">2</span>)) );</span><br><span class="line">        edge-&gt;setVertex( <span class="number">1</span>, <span class="keyword">dynamic_cast</span>&lt;g2o::VertexSE3Expmap*&gt;     (optimizer.vertex(<span class="number">0</span>)) );</span><br><span class="line">        edge-&gt;setMeasurement( Eigen::Vector2d(pts1[i].x, pts1[i].y ) );</span><br><span class="line">        edge-&gt;setInformation( Eigen::Matrix2d::Identity() );</span><br><span class="line">        edge-&gt;setParameterId(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 核函数</span></span><br><span class="line">        edge-&gt;setRobustKernel( <span class="keyword">new</span> g2o::RobustKernelHuber() );</span><br><span class="line">        optimizer.addEdge( edge );</span><br><span class="line">        edges.push_back(edge);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 第二帧</span></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">size_t</span> i=<span class="number">0</span>; i&lt;pts2.size(); i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        g2o::EdgeProjectXYZ2UV*  edge = <span class="keyword">new</span> g2o::EdgeProjectXYZ2UV();</span><br><span class="line">        edge-&gt;setVertex( <span class="number">0</span>, <span class="keyword">dynamic_cast</span>&lt;g2o::VertexSBAPointXYZ*&gt;   (optimizer.vertex(i+<span class="number">2</span>)) );</span><br><span class="line">        edge-&gt;setVertex( <span class="number">1</span>, <span class="keyword">dynamic_cast</span>&lt;g2o::VertexSE3Expmap*&gt;     (optimizer.vertex(<span class="number">1</span>)) );</span><br><span class="line">        edge-&gt;setMeasurement( Eigen::Vector2d(pts2[i].x, pts2[i].y ) );</span><br><span class="line">        edge-&gt;setInformation( Eigen::Matrix2d::Identity() );</span><br><span class="line">        edge-&gt;setParameterId(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 核函数</span></span><br><span class="line">        edge-&gt;setRobustKernel( <span class="keyword">new</span> g2o::RobustKernelHuber() );</span><br><span class="line">        optimizer.addEdge( edge );</span><br><span class="line">        edges.push_back(edge);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;开始优化&quot;</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    optimizer.setVerbose(<span class="literal">true</span>);</span><br><span class="line">    optimizer.initializeOptimization();</span><br><span class="line">    optimizer.optimize(<span class="number">10</span>);</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;优化完毕&quot;</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="comment">//我们比较关心两帧之间的变换矩阵</span></span><br><span class="line">    g2o::VertexSE3Expmap* v = <span class="keyword">dynamic_cast</span>&lt;g2o::VertexSE3Expmap*&gt;( optimizer.vertex(<span class="number">1</span>) );</span><br><span class="line">    Eigen::Isometry3d pose = v-&gt;estimate();</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;Pose=&quot;</span>&lt;&lt;<span class="built_in">endl</span>&lt;&lt;pose.matrix()&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="comment">// 以及所有特征点的位置</span></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">size_t</span> i=<span class="number">0</span>; i&lt;pts1.size(); i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        g2o::VertexSBAPointXYZ* v = <span class="keyword">dynamic_cast</span>&lt;g2o::VertexSBAPointXYZ*&gt; (optimizer.vertex(i+<span class="number">2</span>));</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;vertex id &quot;</span>&lt;&lt;i+<span class="number">2</span>&lt;&lt;<span class="string">&quot;, pos = &quot;</span>;</span><br><span class="line">        Eigen::Vector3d pos = v-&gt;estimate();</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;pos(<span class="number">0</span>)&lt;&lt;<span class="string">&quot;,&quot;</span>&lt;&lt;pos(<span class="number">1</span>)&lt;&lt;<span class="string">&quot;,&quot;</span>&lt;&lt;pos(<span class="number">2</span>)&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 估计inlier的个数</span></span><br><span class="line">    <span class="keyword">int</span> inliers = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">auto</span> e:edges )</span><br><span class="line">    &#123;</span><br><span class="line">        e-&gt;computeError();</span><br><span class="line">        <span class="comment">// chi2 就是 error*\Omega*error, 如果这个数很大，说明此边的值与其他边很不相符</span></span><br><span class="line">        <span class="keyword">if</span> ( e-&gt;chi2() &gt; <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;error = &quot;</span>&lt;&lt;e-&gt;chi2()&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            inliers++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;inliers in total points: &quot;</span>&lt;&lt;inliers&lt;&lt;<span class="string">&quot;/&quot;</span>&lt;&lt;pts1.size()+pts2.size()&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    optimizer.save(<span class="string">&quot;ba.g2o&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span>     <span class="title">findCorrespondingPoints</span><span class="params">( <span class="keyword">const</span> cv::Mat&amp; img1, <span class="keyword">const</span> cv::Mat&amp; img2, <span class="built_in">vector</span>&lt;cv::Point2f&gt;&amp; points1, <span class="built_in">vector</span>&lt;cv::Point2f&gt;&amp; points2 )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cv::ORB orb;</span><br><span class="line">    <span class="built_in">vector</span>&lt;cv::KeyPoint&gt; kp1, kp2;</span><br><span class="line">    cv::Mat desp1, desp2;</span><br><span class="line">    orb( img1, cv::Mat(), kp1, desp1 );</span><br><span class="line">    orb( img2, cv::Mat(), kp2, desp2 );</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;分别找到了&quot;</span>&lt;&lt;kp1.size()&lt;&lt;<span class="string">&quot;和&quot;</span>&lt;&lt;kp2.size()&lt;&lt;<span class="string">&quot;个特征点&quot;</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    cv::Ptr&lt;cv::DescriptorMatcher&gt;  matcher = cv::DescriptorMatcher::create( <span class="string">&quot;BruteForce-Hamming&quot;</span>);</span><br><span class="line">    <span class="keyword">double</span> knn_match_ratio=<span class="number">0.8</span>;</span><br><span class="line">    <span class="built_in">vector</span>&lt; <span class="built_in">vector</span>&lt;cv::DMatch&gt; &gt; matches_knn;</span><br><span class="line">    matcher-&gt;knnMatch( desp1, desp2, matches_knn, <span class="number">2</span> );</span><br><span class="line">    <span class="built_in">vector</span>&lt; cv::DMatch &gt; matches;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">size_t</span> i=<span class="number">0</span>; i&lt;matches_knn.size(); i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (matches_knn[i][<span class="number">0</span>].distance &lt; knn_match_ratio * matches_knn[i][<span class="number">1</span>].distance )</span><br><span class="line">            matches.push_back( matches_knn[i][<span class="number">0</span>] );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (matches.size() &lt;= <span class="number">20</span>) <span class="comment">//匹配点太少</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">auto</span> m:matches )</span><br><span class="line">    &#123;</span><br><span class="line">        points1.push_back( kp1[m.queryIdx].pt );</span><br><span class="line">        points2.push_back( kp2[m.trainIdx].pt );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css"></div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/robotic/">robotic</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/10/25/sophus/"><i class="fa fa-chevron-left">  </i><span>sophus</span></a></div><div class="next-post pull-right"><a href="/2020/10/25/pangolin/"><span>pangolin</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = '' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'AdfkiqY89QUSUWbDY9xJuCh0-gzGzoHsz',
  appKey:'2cEvHcqEWsyoKwy4AUL3kPGh',
  placeholder:'劈个叉吧',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'100',
  lang: 'zh-cn'
})</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2021 By hero576</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.8.2"></script><script src="/js/fancybox.js?version=1.8.2"></script><script src="/js/sidebar.js?version=1.8.2"></script><script src="/js/copy.js?version=1.8.2"></script><script src="/js/fireworks.js?version=1.8.2"></script><script src="/js/transition.js?version=1.8.2"></script><script src="/js/scroll.js?version=1.8.2"></script><script src="/js/head.js?version=1.8.2"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script src="/js/katex.js"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>